<section class="space-y-6">
  <div class="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
    <div class="min-w-0">
      <div class="text-sm text-slate-500">Tenant</div>
      <div class="mt-1 text-2xl font-semibold text-slate-900">Productos</div>
      <div class="text-sm text-slate-500">Gestiona tu catálogo por categoría</div>

      <div class="mt-2 flex flex-wrap items-center gap-2 text-xs text-slate-600">
        <span class="rounded-full border border-slate-200 bg-white px-2 py-1">Total: {{ totalCount() }}</span>
        <span class="rounded-full border border-slate-200 bg-white px-2 py-1">Activos: {{ activeCount() }}</span>
        <span class="rounded-full border border-slate-200 bg-white px-2 py-1">Inactivos: {{ inactiveCount() }}</span>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-2">
      <button
        type="button"
        (click)="openCreate()"
        class="inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800"
      >
        <span class="material-symbols-outlined text-base">add</span>
        Nuevo producto
      </button>

      <button
        type="button"
        (click)="reload()"
        [disabled]="loading()"
        class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed"
      >
        <span class="material-symbols-outlined text-base">refresh</span>
        Recargar
      </button>
    </div>
  </div>

  <app-products-table
    [loading]="loading()"
    [categories]="categories()"
    [products]="filtered()"
    [filterCategoriaId]="filterCategoriaId()"
    [filterQ]="filterQ()"
    [includeInactivos]="includeInactivos()"
    (reload)="reload()"
    (filterCategoriaIdChange)="filterCategoriaId.set($event); reload()"
    (filterQChange)="filterQ.set($event); reload()"
    (includeInactivosChange)="includeInactivos.set($event); reload()"
    (edit)="openEdit($event)"
    (image)="openImage($event)"
    (remove)="remove($event)"
    (restore)="restore($event)"
  />

  <div *ngIf="createOpen()" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-[2px]" (click)="closeCreate()"></div>

    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
      <div class="w-full max-w-lg rounded-2xl bg-white border border-slate-200 shadow-2xl overflow-hidden" role="dialog" aria-modal="true">
        <div class="flex items-start justify-between px-5 py-4 border-b border-slate-200">
          <div class="min-w-0">
            <div class="text-lg font-semibold text-slate-900">Nuevo producto</div>
            <div class="text-sm text-slate-500">Crea un producto dentro de una categoría</div>
          </div>

          <button
            type="button"
            (click)="closeCreate()"
            aria-label="Cerrar"
            class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50"
          >
            <span class="material-symbols-outlined text-base">close</span>
          </button>
        </div>

        <div class="px-5 py-4 max-h-[calc(100dvh-12rem)] overflow-y-auto">
          <app-products-create-card
            [categories]="categories()"
            [loading]="loading()"
            [error]="error()"
            (create)="onCreate($event)"
          />
        </div>

        <div class="px-5 py-4 border-t border-slate-200 flex justify-end">
          <button
            type="button"
            (click)="closeCreate()"
            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50"
          >
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="editOpen()" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-[2px]" (click)="closeEdit()"></div>

    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
      <div class="w-full max-w-xl rounded-2xl bg-white border border-slate-200 shadow-2xl overflow-hidden" role="dialog" aria-modal="true">
        <div class="flex items-start justify-between px-5 py-4 border-b border-slate-200">
          <div class="min-w-0">
            <div class="text-lg font-semibold text-slate-900">Editar producto</div>
            <div class="text-sm text-slate-500">Actualiza datos del producto</div>
          </div>

          <button
            type="button"
            (click)="closeEdit()"
            aria-label="Cerrar"
            class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50"
          >
            <span class="material-symbols-outlined text-base">close</span>
          </button>
        </div>

        <div class="px-5 py-4 max-h-[calc(100dvh-12rem)] overflow-y-auto">
          <form [formGroup]="editForm" class="space-y-3">
            <div class="space-y-1">
              <label class="text-sm font-medium text-slate-700">Categoría</label>
              <input
                type="number"
                formControlName="categoria_id"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
              />
            </div>

            <div class="grid grid-cols-1 gap-2 sm:grid-cols-2">
              <div class="space-y-1">
                <label class="text-sm font-medium text-slate-700">Código</label>
                <input
                  type="text"
                  formControlName="codigo"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
                />
              </div>

              <div class="space-y-1">
                <label class="text-sm font-medium text-slate-700">Estado</label>
                <select
                  formControlName="activo"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
                >
                  <option [ngValue]="true">ACTIVO</option>
                  <option [ngValue]="false">INACTIVO</option>
                </select>
              </div>
            </div>

            <div class="space-y-1">
              <label class="text-sm font-medium text-slate-700">Descripción</label>
              <input
                type="text"
                formControlName="descripcion"
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
              />
            </div>

            <div class="grid grid-cols-1 gap-2 sm:grid-cols-3">
              <div class="space-y-1">
                <label class="text-sm font-medium text-slate-700">Precio</label>
                <input
                  type="number"
                  step="0.01"
                  formControlName="precio"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
                />
              </div>

              <div class="space-y-1">
                <label class="text-sm font-medium text-slate-700">Stock</label>
                <input
                  type="number"
                  step="0.001"
                  formControlName="stock"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
                />
              </div>

              <div class="space-y-1">
                <label class="text-sm font-medium text-slate-700">Stock mínimo</label>
                <input
                  type="number"
                  step="1"
                  formControlName="stock_min"
                  class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
                />
              </div>
            </div>

            <div *ngIf="error()" class="rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700 inline-flex items-start gap-2">
              <span class="material-symbols-outlined text-base">error</span>
              <span class="min-w-0">{{ error() }}</span>
            </div>
          </form>
        </div>

        <div class="flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-2 px-5 py-4 border-t border-slate-200">
          <button
            type="button"
            (click)="closeEdit()"
            class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50"
          >
            Cancelar
          </button>

          <button
            type="button"
            (click)="saveEdit()"
            [disabled]="loading() || editForm.invalid"
            class="inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span class="material-symbols-outlined text-base">save</span>
            Guardar cambios
          </button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="imageOpen()" class="fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-[2px]" (click)="closeImage()"></div>

    <div class="absolute inset-0 flex items-end sm:items-center justify-center p-3 sm:p-6">
      <div class="w-full max-w-lg rounded-2xl bg-white border border-slate-200 shadow-2xl overflow-hidden" role="dialog" aria-modal="true">
        <div class="flex items-start justify-between px-5 py-4 border-b border-slate-200">
          <div class="min-w-0">
            <div class="text-lg font-semibold text-slate-900">Imagen del producto</div>
            <div class="text-sm text-slate-500">Producto #{{ selected()?.producto_id }}</div>
          </div>

          <button
            type="button"
            (click)="closeImage()"
            aria-label="Cerrar"
            class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50"
          >
            <span class="material-symbols-outlined text-base">close</span>
          </button>
        </div>

        <div class="px-5 py-4 space-y-4">
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3 flex items-center gap-3">
            <div class="h-14 w-14 rounded-2xl bg-white border border-slate-200 overflow-hidden flex items-center justify-center">
              <img *ngIf="imageForm.value.image_url" [src]="imageForm.value.image_url" class="h-full w-full object-cover" alt="img" />
              <span *ngIf="!imageForm.value.image_url" class="material-symbols-outlined text-slate-400">image</span>
            </div>
            <div class="min-w-0">
              <div class="text-sm font-semibold text-slate-900 truncate">{{ imageForm.value.image_url || 'Sin imagen' }}</div>
              <div class="text-xs text-slate-500">Vista previa por URL</div>
            </div>
          </div>

          <form [formGroup]="imageForm" class="space-y-3">
            <div class="space-y-1">
              <label class="text-sm font-medium text-slate-700">URL</label>
              <input
                type="text"
                formControlName="image_url"
                placeholder="https://..."
                class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm outline-none focus:border-slate-400 focus:ring-2 focus:ring-slate-200"
              />
            </div>

            <div *ngIf="imageError()" class="rounded-2xl border border-rose-200 bg-rose-50 px-3 py-2 text-sm text-rose-700 inline-flex items-start gap-2">
              <span class="material-symbols-outlined text-base">error</span>
              <span class="min-w-0">{{ imageError() }}</span>
            </div>
          </form>
        </div>

        <div class="flex flex-col-reverse sm:flex-row items-stretch sm:items-center justify-end gap-2 px-5 py-4 border-t border-slate-200">
          <button
            type="button"
            (click)="removeImage()"
            [disabled]="loading()"
            class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span class="material-symbols-outlined text-base">delete</span>
            Quitar
          </button>

          <button
            type="button"
            (click)="saveImage()"
            [disabled]="loading()"
            class="inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800 disabled:opacity-60 disabled:cursor-not-allowed"
          >
            <span class="material-symbols-outlined text-base">save</span>
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>
</section>
