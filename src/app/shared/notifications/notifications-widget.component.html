<div class="relative" *ngIf="enabled()">
  <button
    type="button"
    (click)="toggle()"
    aria-label="notifications"
    class="relative min-h-11 min-w-11 inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50 active:bg-slate-100 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
  >
    <span class="material-symbols-outlined text-[20px]">notifications</span>

    <span
      *ngIf="unread() > 0"
      class="absolute -top-1 -right-1 min-w-5 h-5 px-1 rounded-full bg-rose-600 text-white text-[10px] leading-5 text-center shadow"
    >
      {{ unread() > 99 ? '99+' : unread() }}
    </span>
  </button>

  <div
    *ngIf="open()"
    class="fixed inset-0 z-40 bg-black/30 md:hidden"
    (click)="close()"
  ></div>

  <div
    *ngIf="open()"
    class="z-50 overflow-hidden bg-white border border-slate-200 shadow-xl
           fixed left-3 right-3 top-16 rounded-2xl
           md:absolute md:right-0 md:left-auto md:top-auto md:mt-2 md:w-[22rem] md:max-w-[90vw] md:rounded-xl"
    role="menu"
  >
    <div class="sticky top-0 z-10 bg-white border-b border-slate-200 px-4 py-3 flex items-center gap-2">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">Notificaciones</div>
        <div class="text-[11px] text-slate-500">
          {{ unread() }} unread
          <span *ngIf="unreadOnly()" class="ml-2 rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-semibold text-slate-600">
            Unread only
          </span>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <span *ngIf="loading()" class="text-xs text-slate-500">Loading...</span>

        <button
          type="button"
          (click)="refreshAll()"
          class="min-h-9 inline-flex items-center justify-center gap-1 rounded-lg border border-slate-200 bg-white px-2 py-1 text-xs hover:bg-slate-50 active:bg-slate-100 transition"
        >
          <span class="material-symbols-outlined text-[16px]">refresh</span>
          Refresh
        </button>

        <button
          type="button"
          (click)="close()"
          class="md:hidden min-h-9 min-w-9 inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 active:bg-slate-100 transition"
          aria-label="close"
        >
          <span class="material-symbols-outlined text-[18px]">close</span>
        </button>
      </div>
    </div>

    <div class="max-h-[70dvh] md:max-h-[22rem] overflow-y-auto">
      <div *ngIf="items().length === 0" class="px-4 py-10 text-center">
        <div class="mx-auto grid h-12 w-12 place-items-center rounded-2xl bg-slate-100 text-slate-600">
          <span class="material-symbols-outlined text-[22px]">notifications_off</span>
        </div>
        <div class="mt-3 text-sm font-semibold text-slate-800">No notifications</div>
        <div class="mt-1 text-xs text-slate-500">Try refresh to update.</div>
      </div>

      <button
        *ngFor="let n of items(); trackBy: trackById"
        type="button"
        (click)="markRead(n)"
        class="w-full text-left px-4 py-3 border-b border-slate-100 hover:bg-slate-50 active:bg-slate-100 transition focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-300"
      >
        <div class="flex items-start gap-3">
          <span
            class="mt-1 inline-block h-2.5 w-2.5 rounded-full shrink-0"
            [class.bg-rose-600]="!n.leido_en"
            [class.bg-slate-300]="!!n.leido_en"
          ></span>

          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2">
              <div class="text-sm font-semibold truncate text-slate-900">{{ n.titulo }}</div>
              <span *ngIf="!n.leido_en" class="shrink-0 rounded-full bg-rose-50 px-2 py-0.5 text-[10px] font-semibold text-rose-700">
                New
              </span>
            </div>

            <div class="text-xs text-slate-600 mt-1 sp-clamp-2">{{ n.cuerpo }}</div>
            <div class="text-[11px] text-slate-400 mt-2">{{ formatDate(n.creado_en) }}</div>
          </div>

          <span class="material-symbols-outlined text-[18px] text-slate-400 shrink-0">
            chevron_right
          </span>
        </div>
      </button>
    </div>

    <div class="px-4 py-3 bg-slate-50 flex items-center gap-2">
      <button
        type="button"
        (click)="toggleUnreadOnly()"
        class="min-h-9 inline-flex items-center gap-2 rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs hover:bg-slate-50 active:bg-slate-100 transition"
      >
        <span class="material-symbols-outlined text-[16px]">filter_alt</span>
        {{ unreadOnly() ? 'Unread only' : 'All' }}
      </button>

      <button
        type="button"
        (click)="refreshAll()"
        class="ml-auto min-h-9 inline-flex items-center gap-2 rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800 active:bg-slate-700 transition"
      >
        <span class="material-symbols-outlined text-[16px]">sync</span>
        Update
      </button>
    </div>
  </div>
</div>
